/**
 * ุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุงูููู
 * Legal AI Service - Integration with Google Gemini
 * 
 * ูุฐู ุงูุฎุฏูุฉ ุชููุฑ ุฃุฏูุงุช ุฐูุงุก ุงุตุทูุงุนู ูุชุฎุตุตุฉ ูููุญุงููู
 */

// ุฃููุงุน ุฃุฏูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุงููููุฉ
export type LegalAIToolType = 
  | 'legal_formalization'      // ุชุญููู ุงูุตูุงุบุฉ ุงููุงููููุฉ
  | 'risk_assessment'          // ูุดู ุงูุซุบุฑุงุช ูุงููุฎุงุทุฑ
  | 'plain_language'           // ุชุจุณูุท ุงููุบุฉ
  | 'legal_proofreading'       // ุงูุชุฏููู ุงููุบูู ูุงููุงูููู
  | 'missing_clauses'          // ุงูุชุฑุงุญ ุงูุจููุฏ ุงูุบุงุฆุจุฉ
  | 'executive_summary'        // ุชูุฎูุต ุงููุฐูุฑุงุช
  | 'counter_argument'         // ุชูููุฏ ุงูุญุฌุฌ
  | 'formal_government'        // ุตูุงุบุฉ ุฑุณููุฉ ููุฌูุงุช ุงูุญููููุฉ
  | 'extract_obligations'      // ุงุณุชุฎุฑุงุฌ ุงูุงูุชุฒุงูุงุช
  | 'penalty_clause';          // ุงูุชุฑุงุญ ุดุฑุท ุฌุฒุงุฆู

// ูุงุฌูุฉ ุทูุจ AI
export interface LegalAIRequest {
  tool: LegalAIToolType;
  selectedText: string;
  documentContext?: string;  // ุงูุณูุงู ุงูุฅุถุงูู ูู ุงููุณุชูุฏ
  customInstructions?: string;  // ุชุนูููุงุช ูุฎุตุตุฉ
}

// ูุงุฌูุฉ ุงุณุชุฌุงุจุฉ AI
export interface LegalAIResponse {
  success: boolean;
  result?: string;
  suggestions?: string[];
  warnings?: string[];
  error?: string;
  toolUsed: LegalAIToolType;
  processingTime?: number;
}

// ูุนูููุงุช ุงูุฃุฏุงุฉ ููุนุฑุถ
export interface LegalAIToolInfo {
  id: LegalAIToolType;
  nameAr: string;
  nameEn: string;
  descriptionAr: string;
  icon: string;
  category: 'formalization' | 'analysis' | 'summary' | 'creative';
}

// ูุงุฆูุฉ ุงูุฃุฏูุงุช ุงููุชุงุญุฉ
export const LEGAL_AI_TOOLS: LegalAIToolInfo[] = [
  // ุชุญุณูู ุงูุตูุงุบุฉ
  {
    id: 'legal_formalization',
    nameAr: 'ุตูุงุบุฉ ูุงููููุฉ ุฑุตููุฉ',
    nameEn: 'Legal Formalization',
    descriptionAr: 'ุชุญููู ุงููุต ุฅูู ูุบุฉ ูุงููููุฉ ูุญููุฉ ูุฑุตููุฉ',
    icon: 'โ๏ธ',
    category: 'formalization'
  },
  {
    id: 'plain_language',
    nameAr: 'ุชุจุณูุท ููุนููู',
    nameEn: 'Plain Language',
    descriptionAr: 'ุชุจุณูุท ุงููุต ุงููุงูููู ูุดุฑุญู ููุนููู',
    icon: '๐ฌ',
    category: 'formalization'
  },
  {
    id: 'formal_government',
    nameAr: 'ุตูุงุบุฉ ุญููููุฉ ุฑุณููุฉ',
    nameEn: 'Formal Government',
    descriptionAr: 'ุตูุงุบุฉ ุฑุณููุฉ ููุงุณุจุฉ ููุฌูุงุช ุงูุญููููุฉ',
    icon: '๐๏ธ',
    category: 'formalization'
  },
  // ุงูุชุญููู ุงููุงูููู
  {
    id: 'risk_assessment',
    nameAr: 'ูุดู ุงููุฎุงุทุฑ ูุงูุซุบุฑุงุช',
    nameEn: 'Risk Assessment',
    descriptionAr: 'ุชุญููู ุงููุต ูุชุญุฏูุฏ ุงููุฎุงุทุฑ ูุงูุซุบุฑุงุช ุงููุงููููุฉ',
    icon: '๐',
    category: 'analysis'
  },
  {
    id: 'legal_proofreading',
    nameAr: 'ุงูุชุฏููู ุงููุงูููู ูุงููุบูู',
    nameEn: 'Legal Proofreading',
    descriptionAr: 'ูุญุต ุงูุชูุงูุถุงุช ูุงุชุณุงู ุงููุตุทูุญุงุช',
    icon: 'โ',
    category: 'analysis'
  },
  {
    id: 'missing_clauses',
    nameAr: 'ุงูุชุฑุงุญ ุจููุฏ ููููุฉ',
    nameEn: 'Missing Clauses',
    descriptionAr: 'ุงูุชุฑุงุญ ุจููุฏ ุฅุถุงููุฉ ูููุฉ ุจูุงุกู ุนูู ุงูุณูุงู',
    icon: 'โ',
    category: 'analysis'
  },
  // ุงูุชูุฎูุต ูุงูุฅูุฌุงุฒ
  {
    id: 'executive_summary',
    nameAr: 'ููุฎุต ุชูููุฐู',
    nameEn: 'Executive Summary',
    descriptionAr: 'ุชูุฎูุต ุงููุต ูู ููุงุท ูุฑูุฒุฉ ููุงุถุญุฉ',
    icon: '๐',
    category: 'summary'
  },
  {
    id: 'extract_obligations',
    nameAr: 'ุงุณุชุฎุฑุงุฌ ุงูุงูุชุฒุงูุงุช',
    nameEn: 'Extract Obligations',
    descriptionAr: 'ุงุณุชุฎุฑุงุฌ ุงูุงูุชุฒุงูุงุช ูุงูุญููู ูู ุงููุต',
    icon: '๐',
    category: 'summary'
  },
  // ุงูุฏุนู ุงูุงุจุชูุงุฑู
  {
    id: 'counter_argument',
    nameAr: 'ุชูููุฏ ูุฑุฏูุฏ ูุงููููุฉ',
    nameEn: 'Counter Argument',
    descriptionAr: 'ุงูุชุฑุงุญ ุฑุฏูุฏ ูุงููููุฉ ููุทููุฉ ุนูู ุงูุญุฌุฌ',
    icon: 'โ๏ธ',
    category: 'creative'
  },
  {
    id: 'penalty_clause',
    nameAr: 'ุงูุชุฑุงุญ ุดุฑุท ุฌุฒุงุฆู',
    nameEn: 'Penalty Clause',
    descriptionAr: 'ุงูุชุฑุงุญ ุดุฑุท ุฌุฒุงุฆู ููุงุณุจ ููุจูุฏ',
    icon: '๐ฐ',
    category: 'creative'
  }
];

// ุงูุจุฑููุจุชุงุช ุงููุชุฎุตุตุฉ ููู ุฃุฏุงุฉ
const LEGAL_PROMPTS: Record<LegalAIToolType, string> = {
  legal_formalization: `ุฃูุช ูุญุงูู ุณุนูุฏู ุฎุจูุฑ ูุชุฎุตุต ูู ุงูุตูุงุบุฉ ุงููุงููููุฉ ุงูุฑุตููุฉ.

ุงููููุฉ: ุชุญููู ุงููุต ุงูุชุงูู ุฅูู ุตูุงุบุฉ ูุงููููุฉ ูุญููุฉ ูุฑุตููุฉ ุชุชูุงูู ูุน ุงูุฃุณููุจ ุงููุงูููู ุงูุณุนูุฏู.

ุงูุฅุฑุดุงุฏุงุช:
1. ุงุณุชุฎุฏู ุงููุตุทูุญุงุช ุงููุงููููุฉ ุงูุฏูููุฉ ูุงููุนุชูุฏุฉ ูู ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ
2. ุชุฌูุจ ุงูุบููุถ ูุงูุชูุฑุงุฑ
3. ุงุฌุนู ุงูุนุจุงุฑุงุช ูุงุถุญุฉ ูุง ุชุญุชูู ุงูุชุฃููู
4. ุงุณุชุฎุฏู ุตูุบุฉ ุงููุจูู ูููุฌููู ุนูุฏ ุงูุญุงุฌุฉ
5. ุฑุงุนู ุงูุชุณูุณู ุงูููุทูู ููุฃููุงุฑ
6. ุงุณุชุฎุฏู "ููุชุฒู" ู"ูุชุนูุฏ" ู"ููุฑ" ุจุดูู ุตุญูุญ
7. ุชุฌูุจ ุงูุฃููุงุธ ุงูุนุงููุฉ ุฃู ุบูุฑ ุงูุฑุณููุฉ

ุงููุต ุงููุทููุจ ุชุญูููู:
{TEXT}

ูุฏู ุงููุต ุจุงูุตูุงุบุฉ ุงููุงููููุฉ ุงูุฑุตููุฉ ูุจุงุดุฑุฉ ุฏูู ููุฏูุงุช.`,

  risk_assessment: `ุฃูุช ูุณุชุดุงุฑ ูุงูููู ุณุนูุฏู ูุชุฎุตุต ูู ุชุญููู ุงููุฎุงุทุฑ ุงููุงููููุฉ ูุงูุนููุฏ.

ุงููููุฉ: ุชุญููู ุงููุต ุงูุชุงูู ูุชุญุฏูุฏ ุฌููุน ุงููุฎุงุทุฑ ูุงูุซุบุฑุงุช ุงููุงููููุฉ ุงููุญุชููุฉ.

ุงูุฅุฑุดุงุฏุงุช:
1. ุญุฏุฏ ุงูุจููุฏ ุงูุชู ูุฏ ุชุถุฑ ุจูุตูุญุฉ ุงููููู
2. ุงูุดู ุนู ุงูุบููุถ ุงูุฐู ูุฏ ููุณุชุบู ุถุฏ ุงููููู
3. ุญุฏุฏ ุงูุงูุชุฒุงูุงุช ุบูุฑ ุงููุชูุงุฒูุฉ
4. ุงูุชุดู ุงูุจููุฏ ุงูููููุฏุฉ ุงูุชู ุชุดูู ุฎุทุฑุงู
5. ูููู ูุฏู ุงูุชูุงูู ูุน ุงูุฃูุธูุฉ ุงูุณุนูุฏูุฉ
6. ุญุฏุฏ ุฏุฑุฌุฉ ุงูุฎุทูุฑุฉ ููู ุซุบุฑุฉ (ุนุงููุฉ/ูุชูุณุทุฉ/ููุฎูุถุฉ)

ุงููุต ุงููุฑุงุฏ ุชุญูููู:
{TEXT}

ูุฏู ุงูุชุญููู ุจุดูู ููุธู ูุน ุชุตููู ูู ุฎุทุฑ ูุฏุฑุฌุฉ ุฎุทูุฑุชู ูุงูุชุฑุงุญ ูููุนุงูุฌุฉ.`,

  plain_language: `ุฃูุช ูุณุชุดุงุฑ ูุงูููู ูุชุฎุตุต ูู ุชุจุณูุท ุงููุตูุต ุงููุงููููุฉ ููุนููุงุก.

ุงููููุฉ: ุชุญููู ุงููุต ุงููุงูููู ุงูุชุงูู ุฅูู ูุบุฉ ุจุณูุทุฉ ููุงุถุญุฉ ูููููุง ุงูุดุฎุต ุงูุนุงุฏู.

ุงูุฅุฑุดุงุฏุงุช:
1. ุงุณุชุฎุฏู ูุบุฉ ููููุฉ ุจุณูุทุฉ
2. ุงุดุฑุญ ุงููุตุทูุญุงุช ุงููุงููููุฉ ุจูู ููุณูู ุนูุฏ ุฐูุฑูุง
3. ุงุณุชุฎุฏู ุฃูุซูุฉ ุนูููุฉ ุนูุฏ ุงูุญุงุฌุฉ
4. ูุณูู ุงููุต ุฅูู ููุงุท ูุงุถุญุฉ
5. ุญุงูุธ ุนูู ุงููุนูู ุงููุงูููู ุงูุฏููู
6. ุชุฌูุจ ุงูุฌูู ุงูุทูููุฉ ุงููุนูุฏุฉ

ุงููุต ุงููุงูููู:
{TEXT}

ูุฏู ุงูุดุฑุญ ุงููุจุณุท ูุจุงุดุฑุฉ ุจุดูู ูุงุถุญ ูููููู.`,

  legal_proofreading: `ุฃูุช ูุฏูู ูุงูููู ููุบูู ุณุนูุฏู ูุชุฎุตุต.

ุงููููุฉ: ูุญุต ุงููุต ุงูุชุงูู ูููุดู ุนู ุงูุฃุฎุทุงุก ูุงูุชูุงูุถุงุช.

ุงูุฅุฑุดุงุฏุงุช:
1. ุชุญูู ูู ุงุชุณุงู ุงููุตุทูุญุงุช (ูุซูุงู: ุนุฏู ุงุณุชุฎุฏุงู "ุงููุณุชุฃุฌุฑ" ู"ุงููุณุชุซูุฑ" ูููุณ ุงูุดุฎุต)
2. ุงูุชุดู ุงูุชูุงูุถุงุช ูู ุงูุจููุฏ
3. ุญุฏุฏ ุงูุฃุฎุทุงุก ุงููุญููุฉ ูุงูุฅููุงุฆูุฉ
4. ุชุญูู ูู ุตุญุฉ ุงูุฅุดุงุฑุงุช ูุงูุฃุฑูุงู
5. ุชุญูู ูู ุงูุชูุงู ุงูุฌูู ูุงูุนุจุงุฑุงุช
6. ุชุฃูุฏ ูู ูุถูุญ ุงููุฑุฌุนูุงุช (ูุฐุงุ ุฐููุ ุงููุฐููุฑ ุฃุนูุงู)

ุงููุต ุงููุฑุงุฏ ูุญุตู:
{TEXT}

ูุฏู ูุงุฆูุฉ ุจุงูููุงุญุธุงุช ูุน ูููุนูุง ูุงูุชุฑุงุญ ุงูุชุตุญูุญ.`,

  missing_clauses: `ุฃูุช ูุญุงูู ุณุนูุฏู ุฎุจูุฑ ูู ุตูุงุบุฉ ุงูุนููุฏ ูุงูุงุชูุงููุงุช.

ุงููููุฉ: ุจูุงุกู ุนูู ุงููุต ุงูุชุงููุ ุงูุชุฑุญ ุงูุจููุฏ ุงูููููุฉ ุงูุถุฑูุฑูุฉ.

ุงูุฅุฑุดุงุฏุงุช:
1. ุญุฏุฏ ุงูุจููุฏ ุงูุบุงุฆุจุฉ ุงูุชู ูุฌุจ ุฅุถุงูุชูุง
2. ุงูุชุฑุญ ุดุฑูุท ุงูุถูุงู ุฅู ูู ุชูู ููุฌูุฏุฉ
3. ุงูุชุฑุญ ุขููุฉ ูุถ ุงููุฒุงุนุงุช
4. ุงูุชุฑุญ ุดุฑูุท ุงูุฅููุงุก ูุงููุณุฎ
5. ุงูุชุฑุญ ุจููุฏ ุงูููุฉ ุงููุงูุฑุฉ ุฅู ูุฒู ุงูุฃูุฑ
6. ุฑุงุนู ุทุจูุนุฉ ุงูุนูุฏ ูุงูุณูุงู
7. ุงุฌุนู ูู ุงูุชุฑุงุญ ูุตุงุบุงู ุจุดูู ูุงูููู ุฌุงูุฒ ููุฅุถุงูุฉ

ุงููุต ุงูุฃุตูู:
{TEXT}

ูุฏู ุงูุจููุฏ ุงูููุชุฑุญุฉ ูุน ุดุฑุญ ููุฌุฒ ูุฃูููุฉ ูู ุจูุฏ.`,

  executive_summary: `ุฃูุช ูุณุชุดุงุฑ ูุงูููู ุณุนูุฏู ูุชุฎุตุต ูู ุชูุฎูุต ุงููุณุชูุฏุงุช ุงููุงููููุฉ.

ุงููููุฉ: ุชูุฎูุต ุงููุต ุงูุชุงูู ูู ููุงุท ูุฑูุฒุฉ ููุงุถุญุฉ.

ุงูุฅุฑุดุงุฏุงุช:
1. ุงุณุชุฎุฑุฌ ุงูุฃููุงุฑ ุงูุฑุฆูุณูุฉ ููุท
2. ุฑุชุจ ุงูููุงุท ุญุณุจ ุงูุฃูููุฉ
3. ุญุงูุธ ุนูู ุงูุฏูุฉ ุงููุงููููุฉ
4. ุงุฐูุฑ ุงูุฃุทุฑุงู ูุงูุงูุชุฒุงูุงุช ุงูุฑุฆูุณูุฉ
5. ุญุฏุฏ ุงูููุงุนูุฏ ูุงููุจุงูุบ ุงููููุฉ
6. ูุง ุชุชุฌุงูุฒ 5-7 ููุงุท ุฑุฆูุณูุฉ

ุงููุต ุงููุฑุงุฏ ุชูุฎูุตู:
{TEXT}

ูุฏู ุงูููุฎุต ุงูุชูููุฐู ูู ููุงุท ูุงุถุญุฉ ููุฑููุฉ.`,

  counter_argument: `ุฃูุช ูุญุงูู ุณุนูุฏู ูุชูุฑุณ ูู ุงููุฑุงูุนุงุช ูุงูุฑุฏูุฏ ุงููุงููููุฉ.

ุงููููุฉ: ุงูุชุฑุงุญ ุฑุฏูุฏ ูุงููููุฉ ููุทููุฉ ุนูู ุงูุญุฌุฉ ุฃู ุงูุงุฏุนุงุก ุงูุชุงูู.

ุงูุฅุฑุดุงุฏุงุช:
1. ุญูู ุงูุญุฌุฉ ูุญุฏุฏ ููุงุท ุถุนููุง
2. ุงุณุชูุฏ ุฅูู ุงูุฃูุธูุฉ ุงูุณุนูุฏูุฉ ุงููุนููู ุจูุง
3. ูุฏู 3-5 ุฑุฏูุฏ ูุงููููุฉ ูุชููุนุฉ
4. ุงุฐูุฑ ุงูุณูุฏ ุงููุธุงูู ุฅู ูุฌุฏ
5. ุงุณุชุฎุฏู ุฃุณููุจ ุงููุฑุงูุนุงุช ุงููุงููููุฉ
6. ุฑุงุนู ุงูููุทู ุงููุงูููู ุงูุณููู

ุงูุญุฌุฉ ุฃู ุงูุงุฏุนุงุก:
{TEXT}

ูุฏู ุงูุฑุฏูุฏ ุงููุงููููุฉ ุงูููุชุฑุญุฉ ุจุดูู ููุธู ููููุน.`,

  formal_government: `ุฃูุช ูุงุชุจ ูุงูููู ูุชุฎุตุต ูู ุงููุฎุงุทุจุงุช ุงูุฑุณููุฉ ููุฌูุงุช ุงูุญููููุฉ ุงูุณุนูุฏูุฉ.

ุงููููุฉ: ุฅุนุงุฏุฉ ุตูุงุบุฉ ุงููุต ุงูุชุงูู ุจุฃุณููุจ ุฑุณูู ููุงุณุจ ููุฌูุงุช ุงูุญููููุฉ.

ุงูุฅุฑุดุงุฏุงุช:
1. ุงุณุชุฎุฏู ุตูุบุฉ ุงููุฎุงุทุจุฉ ุงูุฑุณููุฉ (ูุนุงููุ ุณุนุงุฏุฉุ ุฅูุฎ)
2. ุงุจุฏุฃ ุจุงูุชุญูุฉ ุงูุฑุณููุฉ ุงูููุงุณุจุฉ
3. ุงุณุชุฎุฏู ูุบุฉ ุฑุณููุฉ ูุญุชุฑูุฉ
4. ุฑุงุนู ุงูุชุณูุณู ุงูุฅุฏุงุฑู
5. ุงุณุชุฎุฏู "ุฃุฑุฌู ุงูุชูุฑู" ู"ูุฃูู" ู"ูุฑูู ููู"
6. ุงุฎุชู ุจุนุจุงุฑุงุช ุงูุงุญุชุฑุงู ุงูููุงุณุจุฉ

ุงููุต ุงูุฃุตูู:
{TEXT}

ูุฏู ุงููุต ุจุงูุตูุงุบุฉ ุงูุฑุณููุฉ ุงูุญููููุฉ ูุจุงุดุฑุฉ.`,

  extract_obligations: `ุฃูุช ูุญูู ุนููุฏ ุณุนูุฏู ูุชุฎุตุต ูู ุงุณุชุฎุฑุงุฌ ุงูุงูุชุฒุงูุงุช ูุงูุญููู.

ุงููููุฉ: ุงุณุชุฎุฑุงุฌ ุฌููุน ุงูุงูุชุฒุงูุงุช ูุงูุญููู ูู ุงููุต ุงูุชุงูู.

ุงูุฅุฑุดุงุฏุงุช:
1. ุญุฏุฏ ุงูุชุฒุงูุงุช ูู ุทุฑู ุจุดูู ูููุตู
2. ุญุฏุฏ ุญููู ูู ุทุฑู ุจุดูู ูููุตู
3. ุงุฐูุฑ ุงูููุงุนูุฏ ูุงูุดุฑูุท ุงููุฑุชุจุทุฉ
4. ุญุฏุฏ ุงูุนููุจุงุช ุงููุชุฑุชุจุฉ ุนูู ุงูุฅุฎูุงู
5. ุฑุชุจ ุงูุงูุชุฒุงูุงุช ุญุณุจ ุงูุฃููููุฉ ุงูุฒูููุฉ
6. ุงุณุชุฎุฏู ุฌุฏุงูู ูุงุถุญุฉ ุฅู ุฃููู

ุงููุต ุงููุฑุงุฏ ุชุญูููู:
{TEXT}

ูุฏู ุฌุฏููุงู ูุงุถุญุงู ุจุงูุงูุชุฒุงูุงุช ูุงูุญููู ููู ุทุฑู.`,

  penalty_clause: `ุฃูุช ูุญุงูู ุณุนูุฏู ูุชุฎุตุต ูู ุตูุงุบุฉ ุงูุดุฑูุท ุงูุฌุฒุงุฆูุฉ.

ุงููููุฉ: ุงูุชุฑุงุญ ุดุฑุท ุฌุฒุงุฆู ููุงุณุจ ููุจูุฏ ุฃู ุงูุงูุชุฒุงู ุงูุชุงูู.

ุงูุฅุฑุดุงุฏุงุช:
1. ุงุฌุนู ุงูุดุฑุท ุงูุฌุฒุงุฆู ูุชูุงุณุจุงู ูุน ุงูุถุฑุฑ ุงููุชููุน
2. ุฑุงุนู ุฃุญูุงู ุงูุดุฑูุนุฉ ุงูุฅุณูุงููุฉ ูุงูุฃูุธูุฉ ุงูุณุนูุฏูุฉ
3. ุญุฏุฏ ุขููุฉ ุงุญุชุณุงุจ ุงูุชุนููุถ
4. ุงุฐูุฑ ุงูุญุงูุงุช ุงููุณุชุซูุงุฉ (ุงูููุฉ ุงููุงูุฑุฉ ูุซูุงู)
5. ุงุฌุนู ุงูุตูุงุบุฉ ูุงุถุญุฉ ูุง ุชุญุชูู ุงูุชุฃููู
6. ูุฏู ุฃูุซุฑ ูู ุฎูุงุฑ ุจุฏุฑุฌุงุช ูุฎุชููุฉ

ุงูุจูุฏ ุฃู ุงูุงูุชุฒุงู:
{TEXT}

ูุฏู 2-3 ุตูุบ ูุฎุชููุฉ ููุดุฑุท ุงูุฌุฒุงุฆู ูุน ุชูุถูุญ ูููุฒุงุช ูู ุตูุบุฉ.`
};

// ููุชุงุญ API - ูููุฑุฃ ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูู Vercel
// VITE_OPENROUTER_API_KEY ูุฌุจ ุฅุถุงูุชู ูู Vercel Dashboard > Settings > Environment Variables
const getApiKeyFromEnv = (): string | null => {
  try {
    return import.meta.env.VITE_OPENROUTER_API_KEY || null;
  } catch {
    return null;
  }
};

// ูุชุบูุฑ ูุชุฎุฒูู API Key
let geminiApiKey: string | null = getApiKeyFromEnv();

// ุฏุงูุฉ ูุชุนููู API Key
export function setGeminiApiKey(apiKey: string): void {
  geminiApiKey = apiKey;
}

// ุฏุงูุฉ ููุญุตูู ุนูู API Key
export function getGeminiApiKey(): string | null {
  return geminiApiKey || getApiKeyFromEnv();
}

// ุฏุงูุฉ ููุณุญ API Key
export function clearGeminiApiKey(): void {
  geminiApiKey = null;
}

// ุงูุชุญูู ูู ูุฌูุฏ API Key
export function hasGeminiApiKey(): boolean {
  return !!geminiApiKey;
}

/**
 * ุงุณุชุฏุนุงุก OpenRouter API
 */
async function callGeminiAPI(prompt: string): Promise<string> {
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    throw new Error('ูู ูุชู ุชุนููู ููุชุงุญ API. ูุฑุฌู ุฅุฏุฎุงู ุงูููุชุงุญ ูู ุงูุฅุนุฏุงุฏุงุช.');
  }

  const response = await fetch(
    'https://openrouter.ai/api/v1/chat/completions',
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
        'HTTP-Referer': window.location.origin,
        'X-Title': 'Law Firm System',
      },
      body: JSON.stringify({
        model: 'google/gemini-3-flash-preview',
        messages: [
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 4096,
      }),
            threshold: 'BLOCK_ONLY_HIGH'
          },
          {
            category: 'HARM_CATEGORY_HATE_SPEECH',
            threshold: 'BLOCK_ONLY_HIGH'
          },
          {
            category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT',
            threshold: 'BLOCK_ONLY_HIGH'
          },
          {
            category: 'HARM_CATEGORY_DANGEROUS_CONTENT',
            threshold: 'BLOCK_ONLY_HIGH'
          }
        ]
      })
    }
  );

  if (!response.ok) {
    const errorData = await response.json().catch(() => ({}));
    if (response.status === 401 || response.status === 403) {
      throw new Error('ููุชุงุญ API ุบูุฑ ุตุงูุญ. ูุฑุฌู ุงูุชุญูู ูู ุงูููุชุงุญ.');
    }
    if (response.status === 429) {
      throw new Error('ุชู ุชุฌุงูุฒ ุญุฏ ุงูุงุณุชุฎุฏุงู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.');
    }
    throw new Error(errorData.error?.message || `ุฎุทุฃ ูู ุงูุงุชุตุงู ุจู Gemini: ${response.status}`);
  }

  const data = await response.json();
  
  // ุงุณุชุฎุฑุงุฌ ุงููุต ูู ุงูุงุณุชุฌุงุจุฉ
  const generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text;
  if (!generatedText) {
    throw new Error('ูู ูุชู ุงุณุชูุงู ุฑุฏ ูู Gemini. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
  }

  return generatedText;
}

/**
 * ูุนุงูุฌุฉ ุทูุจ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงููุงูููู
 */
export async function processLegalAIRequest(request: LegalAIRequest): Promise<LegalAIResponse> {
  const startTime = Date.now();

  try {
    // ุงูุชุญูู ูู ูุฌูุฏ ูุต
    if (!request.selectedText?.trim()) {
      return {
        success: false,
        error: 'ูุฑุฌู ุชุญุฏูุฏ ูุต ูููุนุงูุฌุฉ',
        toolUsed: request.tool
      };
    }

    // ุงูุญุตูู ุนูู ุงูุจุฑููุจุช ุงูููุงุณุจ
    const promptTemplate = LEGAL_PROMPTS[request.tool];
    if (!promptTemplate) {
      return {
        success: false,
        error: 'ุฃุฏุงุฉ ุบูุฑ ูุนุฑููุฉ',
        toolUsed: request.tool
      };
    }

    // ุจูุงุก ุงูุจุฑููุจุช ุงูููุงุฆู
    let finalPrompt = promptTemplate.replace('{TEXT}', request.selectedText);
    
    // ุฅุถุงูุฉ ุงูุณูุงู ุฅู ูุฌุฏ
    if (request.documentContext) {
      finalPrompt = `ุณูุงู ุงููุณุชูุฏ:\n${request.documentContext}\n\n${finalPrompt}`;
    }

    // ุฅุถุงูุฉ ุชุนูููุงุช ูุฎุตุตุฉ ุฅู ูุฌุฏุช
    if (request.customInstructions) {
      finalPrompt += `\n\nุชุนูููุงุช ุฅุถุงููุฉ: ${request.customInstructions}`;
    }

    // ุงุณุชุฏุนุงุก API
    const result = await callGeminiAPI(finalPrompt);

    const processingTime = Date.now() - startTime;

    return {
      success: true,
      result,
      toolUsed: request.tool,
      processingTime
    };

  } catch (error) {
    const processingTime = Date.now() - startTime;
    return {
      success: false,
      error: error instanceof Error ? error.message : 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน',
      toolUsed: request.tool,
      processingTime
    };
  }
}

/**
 * ุงูุญุตูู ุนูู ูุนูููุงุช ุฃุฏุงุฉ ูุนููุฉ
 */
export function getToolInfo(toolType: LegalAIToolType): LegalAIToolInfo | undefined {
  return LEGAL_AI_TOOLS.find(tool => tool.id === toolType);
}

/**
 * ุงูุญุตูู ุนูู ุงูุฃุฏูุงุช ุญุณุจ ุงููุฆุฉ
 */
export function getToolsByCategory(category: LegalAIToolInfo['category']): LegalAIToolInfo[] {
  return LEGAL_AI_TOOLS.filter(tool => tool.category === category);
}
